---
title: "Diet Compositions and Obesity"
author: "Ken Ye"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r}
# Load libraries
library(knitr)
library(kableExtra)
library(dplyr)
library(betareg)
library(ggplot2)
library(gridExtra)
library(car)
library(glmnet)
library(mice)
```

```{r include = FALSE}
# Load data set
supply <- read.csv("Data/dietary-composition-by-country.csv")
death <- read.csv("Data/share-of-deaths-obesity.csv")
# gdp <- read.csv("Data/gdp-per-capita-worldbank.csv")
income.group <- read.csv("Data/world-banks-income-groups.csv")
```

# Introduction

A staggering number of 37.3% of the US population is obese,

The USDA Center for Nutrition Policy and Promotion recommends a very
simple daily diet intake guideline: 30% grains, 40% vegetables, 10%
fruits, and 20% protein. [1] [2]

![MyPlate Guildlines](Data/MyPlate.png)

\newpage

# Data

## Data Cleaning

```{r}
# Filter out 2019 data (newest for both data sets)
# Filter out entities without code (not countries)
supply <- supply |>
  filter(Code != "", Year == 2019) |>
  select(-Code, -Year)

death <- death |>
  filter(Code != "",Year == 2019) |>
  select(-Code, -Year)

# gdp <- gdp |>
#  filter(Code != "",Year == 2019) |>
#  select(-Code, -Year)

income.group <- income.group |>
  filter(Code != "",Year == 2019) |>
  select(-Code, -Year)

# Rename variables
colnames(supply) <- c("Country", "Miscellaneous", "Alcohol", "Animal.fat", "Vegetable.oils", "Oilcrops", "Fish.and.seafood", "Sugar.crops", "Sugar.sweeteners", "Starchy.roots", "Meat.other", "Meat.sheep.and.goat", "Meat.pig", "Meat.poultry", "Meat.beef", "Eggs", "Milk", "Nuts", "Fruit", "Vegetables", "Pulses", "Cereals.other", "Barley", "Maize", "Rice", "Wheat")

colnames(death) <- c("Country", "Death.obesity")

# colnames(gdp) <- c("Country", "GDP.per.capita")

colnames(income.group) <- c("Country", "Income.group")
```

```{r}
# Merge data sets
df <- merge(supply, income.group, by = "Country", all = FALSE)
# df <- merge(df, gdp, by = "Country", all = FALSE)
df <- merge(df, death, by = "Country", all = FALSE)
```

## Missing Data Imputation

```{r include = FALSE}
# Create a mice imputation object
mice_imputation <- mice(df, method = "pmm")

# Perform the imputation
df <- complete(mice_imputation)
```

In my analysis, I encountered missing values in certain food groups
across countries. Removing these entries would significantly reduce the
dataset entries, leaving only 100 out of 174 countries with 45 degrees
of freedom for model fitting (if all columns are utilized for the
model). This approach would not be ideal for accurately representing
global patterns or obtaining robust model estimates.

To address this challenge, I opted for imputation using the "predictive
mean matching"(PMM) method from the `mice` package. PMM ensures that
imputed values are drawn from observed values with similar predicted
values, preserving the distributional characteristics of the data. This
method allows us to utilize the full dataset, providing a more
comprehensive and representative view of the relationships between food
supply patterns and obesity death rates across diverse countries.
Imputing missing values with PMM contributes to the validity of our
inferences and enhances the generalizability of my findings to a broader
global context.

## EDA

\newpage

# Methodology

```{r}
# Split data into 80% training, 20% testing
x <- model.matrix(Death.obesity ~ . - Country, df)[,-1]
y <- df$Death.obesity

set.seed(1)
train <- sample(1:nrow(x), floor(nrow(x)*0.8))
test <- setdiff(1:nrow(x), train)
y.test <- y[test]
```

## Simple Linear Regression Model

```{r results = "hide"}
lm <- lm(y ~ x, subset = train)
lm.pred <- predict(lm, newx = x[test,])
summary(lm)
```

## Lasso Regression Model

```{r}
lasso.mod <- glmnet(x[train,], y[train], alpha = 1)
par(mar = c(6, 6, 6, 6))
plot(lasso.mod, main = "Lasso Regularization Path")
```

```{r}
# CV
set.seed(1)
cv.out <- cv.glmnet(x[train,], y[train], alpha = 1)
par(mar = c(6, 6, 6, 6))
plot(cv.out, main = "Lasso Prediction Error")
bestlam <- cv.out$lambda.min
lasso.pred <- predict(lasso.mod, s = bestlam, newx = x[test,])
```

```{r results = "hide"}
print(bestlam)
```

## Model Comparison

```{r results = "hide"}
# Simple LM MSE
mean((lm.pred - y.test)^2)
```

```{r results = "hide"}
# Lasso MSE
mean((lasso.pred - y.test)^2)
```

## Final Model

```{r results = "hide"}
# Lasso
out <- glmnet(x, y, alpha = 1)
lasso.coef <- predict(out, type = "coefficients", s = bestlam)
lasso.coef
```

\newpage

# Results

```{r}
# Convert the coefficient matrix to a regular matrix
lasso_coefs_matrix <- as.matrix(lasso.coef)

# Convert the matrix to a data frame
lasso_coefs_df <- as.data.frame(lasso_coefs_matrix)
lasso_coefs_df <- round(lasso_coefs_df, 3)

colnames(lasso_coefs_df) <- c("Coefficient")

kable(lasso_coefs_df)
```

```{r}
lasso_coefs_df <- lasso_coefs_df |>
  filter(Coefficient != 0)

kable(lasso_coefs_df)
```

\newpage

# Conclusion

![MyPlate Plan](Data/MyPlate%20Plan.jpg)

## Limitations

1)  supply, not consumption. assuming consumption is proportional to
    supply.

\newpage

# Citations

[1] <https://www.dietaryguidelines.gov/>

[2] <https://www.myplate.gov/>
